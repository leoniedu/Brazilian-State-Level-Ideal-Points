library(ggplot2)
library(Hmisc)
library(foreign)

normalize.df <- function(x) {
    data.frame(lapply(x, function(z) if (is.character(z)|is.factor(z)) {
        tolower(z)
    } else {
        z
    }))
}



years <- c(1990, 1993, 1997, 2001, 2005)
dnow <- lapply(years, function(i) {
  res <- read.spss(paste(i, "-survey-weighted.sav", sep="")
                   , to.data.frame=TRUE)
  names(res) <- tolower(names(res))
  res
})
years <- c(years, 2009)
dnow <- c(dnow, list(read.dta("plio139-23aug.dta")))
dnow[[1]] <- within(dnow[[1]], {
    resp <- ave(ppweight, pp90, FUN=length)
    seats <- ((ppweight*resp)/length(ppweight))*570
    rs <- resp/seats
})
dnow[[2]] <- within(dnow[[2]], {
    resp <- ave(ppweight, pp93, FUN=length)
    seats <- ((ppweight*resp)/length(ppweight))*584
    rs <- resp/seats
})
dnow[[3]] <- within(dnow[[3]], {
    resp <- ave(ppweight, pp97, FUN=length)
  seats <- ((ppweight*resp)/length(ppweight))*594
    rs <- resp/seats
})
dnow[[4]] <- within(dnow[[4]], {
    resp <- ave(ppweight, pp2001, FUN=length)
    seats <- ((ppweight*resp)/length(ppweight))*594
    rs <- resp/seats
})
dnow[[5]] <- within(dnow[[5]], {
    resp <- ave(ppweight, pp2005, FUN=length)
    seats <- ((ppweight*resp)/length(ppweight))*594
    rs <- resp/seats
})
dnow[[6]] <- within(dnow[[6]], {
    resp <- ave(pweight, pp2009, FUN=length)
    seats <- ((pweight*resp)/length(pweight))*594
    rs <- resp/seats
})
names(dnow) <- years
dnow <- lapply(dnow,
               function(x) {
                   if (!"ppvsreg"%in%names(x)) {
                       x$ppvsreg <- NA
                   }
                   x$ppvsreg <- tolower(x$ppvsreg)
                   x
               }
               )

dnow[[1]]$party <- dnow[[1]]$pp90
dnow[[2]]$party <- dnow[[2]]$pp93
dnow[[3]]$party <- dnow[[3]]$pp97
dnow[[4]]$party <- dnow[[4]]$pp2001
dnow[[5]]$party <- dnow[[5]]$pp2005
dnow[[6]]$party <- dnow[[6]]$pp2009


library(plyr)
dall <- ldply(dnow,
              function(x) {
                  res <- data.frame(x[,c("caseid", "party", "ppvsreg", "resp", "seats", "rs", "state",grep("^lr.*", names(x), value=TRUE))])
                  res
              }
              )
dall <- normalize.df(dall)
dall$lrdiap <- NULL



recode.party <- function(x) car::recode(x, "'dem'='pfl'; c('pcdb','pc do b')='pcdob'; c('pp','ppr-pds-pdc','ppb-ppr','ppb','pds')='pp'")
dall$partyrec <- recode.party(dall$party)




dall$localism <- factor(dall$ppvsreg, levels=c("votes party interests",
                                      "splits party and local interests",
                                      "votes local interests"))

save(dall, file="dall.RData")


p <- qplot(.id, value, colour=localism, data=melt(prop.table(with(dall, table(localism, .id)), margin=2))) + scale_y_continuous(name="", limits=c(0,1)) + theme_bw()




## MODEL
model {
    sdp <- 1000
    for (i in 1:n.rows) {
        yb[i] ~ dnorm(ilogit(xb[i]), tau.y)
   	xb[i] <- b0[legis[i]] + b1[legis[i]] * party[party.i[i]]
    }
    tau.y ~ dgamma(.01, .01)
    for (j in 1:n.party) {
        party[j] ~ dnorm(0, pow(sdp, -2))
    }
    for (j in 1:n.legis) {
        b0[j] ~ dnorm(mu.0, tau.0)
        b1[j] ~ dnorm(mu.1, tau.1)
    }
    sigma.0 ~ dunif(0, sdp)
    tau.0 <- pow(sigma.0,-2)
    sigma.1 ~ dunif(0, sdp)
    tau.1 <- pow(sigma.1,-2)
    mu.0 ~ dnorm(0, pow(sdp, -2))
    mu.1 ~ dunif(0, sdp)
}



lr <- dall
lr <- subset(dall, .id==2005)

lr$self <- lr$lrclass
lr <- melt(lr,
           id.var=c(".id", "caseid", "party",  "state", "lrclass"),
           measure.var=grep("lr",names(lr), value=TRUE))
lr$year <- as.numeric(as.character(lr$.id))
lr <- subset(lr,(!is.na(value)))
## party measured
lr$party.i.factor <- factor(recode.party(substr(lr$variable,3,100)))
lr$party.i <- as.numeric(lr$party.i.factor)
## party of the legislator
lr$party.j.factor <- factor(recode.party(lr$party))
lr$legis.factor <- with(lr, factor(paste(.id,caseid,sep=";")))
lr$legis <- as.numeric(lr$legis.factor)

lrself <- subset(lr, as.character(party.i.factor)==as.character(party.j.factor))
lrself$leftism <- with(lrself, as.numeric(value)-lrclass)








    
n.rows <- nrow(lr)
y <- lr$value
legis <- lr$legis
party.i <- lr$party.i
n.legis <- max(legis)
n.party <- max(party.i)
lrclass <- lrself$lrclass

inits <- function(){
    b0 <- rnorm(n.legis)
    b1 <- runif(n.legis)
    list(b0=b0, b1=b1, sigma.y=runif(1), sigma.0=runif(1), sigma.1=runif(1))    
}










parameters.to.save <- c("b0","b1", "b0.pp","b1.pp" , "sigma.y", "sigma.0", "sigma.1", "party", "mu.0", "mu.1", "party.pp")

## missing data on lrclass. have to predict outside bugs
jags.data <- Hmisc::llist(y,party.i, legis, n.rows, n.party, n.legis
                          ##, lrclass
                          )

##"Satire is a sort of glass, wherein beholders do generally discover everybody's face but their own" - Jonathan Swift
    
library(R2WinBUGS)
library(rjags)
source("~/reps/eduRdo/R/utils.R")

try(rm(jags1,jags1.s))
system.time(jags1 <- jags.model(file="model2.bug",data=jags.data, inits=inits, n.adapt=1000,n.chains=2))

system.time(jags1.s <- coda.samples(jags1,variable.names=parameters.to.save, n.iter=1000 , thin=1))


tmp <- coda2bugs(jags1.s, parms.tokeep="party")
shift <- apply(tmp$sims.list$party,1,mean)
scale <- apply(tmp$sims.list$party,1,sd)
party <- (tmp$sims.list$party-shift)/scale
b0 <- (coda2bugs(jags1.s, parms.tokeep="b0")$sims.list$b0-shift)*scale
b1 <- (coda2bugs(jags1.s, parms.tokeep="b1")$sims.list$b1)*scale
tmp <- merge(lrself,data.frame(legis=1:n.legis, b0=apply(b0,2,mean), b1=apply(b1,2,mean)))
tmp$lrclass.pp <- with(tmp, (b0+b1*lrclass))
hist(tmp$lrclass.pp)



party <- coda2bugs(jags1.s, parms.tokeep="party.pp")

b0 <- coda2bugs(jags1.s, parms.tokeep="b0.pp")
b1 <- coda2bugs(jags1.s, parms.tokeep="b1.pp")



ploc <- data.frame(party=levels(lr$party.i.factor), xparty=party$median[[1]], xpartysd=party$sd[[1]])
tmp <- recast(lr, party.i.factor ~ variable, id.var=c("party.i.factor"), measure.var="value", fun.aggregate=mean, na.rm=TRUE)
names(tmp) <- c("party", "xpartyraw")
ploc <- merge(ploc, tmp)
save(ploc, file="ploc.RData")


lrpos <- merge(lrself, data.frame(legis=1:n.legis, b0=b0$median[[1]], b1=b1$median[[1]]))

lrpos$x <- with(lrpos, b0+b1*lrclass)

lrpos <- merge(ploc, lrpos, by.x="party" ,by.y="party.j.factor")




## summary by party
lrpos$variable <- NULL
tmp <- recast(lrpos, party ~ variable, measure.var=c("x", "lrclass", "xparty", "xpartyraw"), fun.aggregate=mean, na.rm=TRUE)

qplot(x, xparty, data=tmp)





qplot(x, data=subset(lrpos, party.j.factor=="pmdb"), facets=~state, xlim=c(1,10))









library(Zelig)
m1 <- zelig(localism ~ .id + party , data=dall, model="ologit")




library(Design)

lrm(localism ~ party + .id , data=dall)

dim(dall)



theme_bw
function (base_size = 12) 
{
    structure(list(axis.line = theme_blank(),
                   axis.text.x = theme_text(size = base_size * 
                     0.8, lineheight = 0.9, vjust = 1),
                   axis.text.y = theme_text(size = base_size * 
                     0.8, lineheight = 0.9, hjust = 1),
                   axis.ticks = theme_segment(colour = "black", 
                     size = 0.2),
                   axis.title.x = theme_text(size = base_size, 
                     vjust = 1),
                   axis.title.y = theme_text(size = base_size, 
                     angle = 90, vjust = 0.5), axis.ticks.length = unit(0.3, 
        "lines"), axis.ticks.margin = unit(0.5, "lines"), legend.background = theme_rect(colour = NA), 
        legend.key = theme_rect(colour = "grey80"), legend.key.size = unit(1.2, 
            "lines"), legend.text = theme_text(size = base_size * 
            0.8), legend.title = theme_text(size = base_size * 
            0.8, face = "bold", hjust = 0), legend.position = "right", 
        panel.background = theme_rect(fill = "white", colour = NA), 
        panel.border = theme_rect(fill = NA, colour = "grey50"), 
        panel.grid.major = theme_line(colour = "grey90", size = 0.2), 
        panel.grid.minor = theme_line(colour = "grey98", size = 0.5), 
        panel.margin = unit(0.25, "lines"), strip.background = theme_rect(fill = "grey80", 
            colour = "grey50"), strip.text.x = theme_text(size = base_size * 
            0.8), strip.text.y = theme_text(size = base_size * 
            0.8, angle = -90), plot.background = theme_rect(colour = NA), 
        plot.title = theme_text(size = base_size * 1.2), plot.margin = unit(c(1, 
            1, 0.5, 0.5), "lines")), class = "options")
}



qplot(years, sapply(dnow, nrow)) + scale_y_continuous(limits=c(0, 513), expand=c(0, 0)) +scale_x_continuous(limits=c(min(c(years)), 2013), breaks=c(years, 2009))+
  annotate("text", x=2009, y=110, label="?", size=8, colour="darkblue")+
  annotate("text", x=2013, y=90, label="?", size=8, colour="darkred")+theme_bw()
